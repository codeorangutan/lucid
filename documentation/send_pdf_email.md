# Sending PDF Reports via Email Utility

## Overview
This utility provides a modular way to send PDF reports as email attachments using the Gmail API. It is designed to be used both as a standalone script (CLI) and as an importable function within the Lucid App orchestration pipeline.

- **Script Location:** `src/send_pdf_email.py`
- **Dependencies:** Uses authentication and logging from `src/email_receiver.py` (OAuth2 via credentials.json/token.pickle)
- **Purpose:** Send a specified PDF file to a given email address, with a customizable subject and body.

---

## Usage

### 1. As a Command-Line Tool

```bash
# Send to a specific email directly
python src/send_pdf_email.py --pdf /path/to/report.pdf --email recipient@example.com [--subject "Subject"] [--body "Body text"]

# OR: Look up the referrer's email from the database using patient ID and year of birth
python src/send_pdf_email.py --pdf /path/to/report.pdf --patient-id 40265 --yob 1982 [--subject "Subject"] [--body "Body text"]
```
- `--pdf` (required): Path to the PDF file to send
- `--email` (optional): Recipient's email address (takes precedence if provided)
- `--patient-id` (optional): Patient's ID number for DB lookup (must be used with `--yob` if `--email` is not provided)
- `--yob` (optional): Year of birth (4 digits) for DB lookup (must be used with `--patient-id` if `--email` is not provided)
- `--subject` (optional): Email subject (default: "Lucid Cognitive report is attached")
- `--body` (optional): Email body text (default: "Please find your report attached. Patient's Id number is in the name of the report.")

**If both `--email` and `--patient-id`/`--yob` are provided, `--email` is used.**

### 2. As a Python Function

```python
from src.send_pdf_email import send_pdf_via_email
send_pdf_via_email(
    pdf_path="/path/to/report.pdf",
    recipient_email="recipient@example.com",  # Or use the db lookup function for referrer email
    subject="Lucid Cognitive report is attached",
    body="Please find your report attached. Patient's Id number is in the name of the report."
)
```

---

## Database Lookup for Referrer Email
- The script can look up the referrer's email from the `referrals` table in the database using a combination of patient ID (`id_number`) and year of birth (`yob`, 4 digits).
- This is handled by the function `get_referrer_email_by_patient_id_yob(patient_id, yob)` in `src/db.py`.
- If no matching referral is found, or the email is missing, an error is raised and logged.

---

## Integration Notes
- **Authentication:** Uses Gmail API credentials from `credentials/credentials.json` and `credentials/token.pickle` (see `email_receiver.py`).
- **Logging:** Logs actions and errors to `lucid_email_receiver.log` (same as other email modules).
- **Error Handling:** Raises exceptions for missing files, authentication errors, failed sends, or missing referral emails. All errors are logged.
- **No Hardcoding:** All paths and credentials are configurable via arguments or environment variables.
- **Testability:** Code is modular and test-friendly. Add a dry-run or test mode if needed.

---

## Example Workflow

1. Generate a report PDF using the pipeline (see `report_pdf_playwright.py`).
2. Send the PDF to the referrer or patient using this utility, either by direct email or by DB lookup.
3. Integrate as a step in the orchestration pipeline or use manually for ad-hoc sends.

---

## Troubleshooting
- Ensure Gmail API credentials are valid and OAuth tokens are present.
- Check `lucid_email_receiver.log` for detailed logs.
- If you encounter errors, verify file paths, recipient email, patient ID/year of birth, and Gmail API settings.

---

## See Also
- [report_generation_pipeline.md](report_generation_pipeline.md)
- [current_pipeline_overview.md](current_pipeline_overview.md)
- [src/email_receiver.py](../src/email_receiver.py)
- [src/db.py](../src/db.py)

---

*Document generated by Cascade AI, 2025-05-03. For updates, rerun or consult the latest codebase and documentation.*
