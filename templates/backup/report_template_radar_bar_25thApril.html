<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHD Cognitive Assessment Report Template</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eff6ff; /* bg-blue-50 */
        }
        /* Custom styles for severity/classification badges */
        .badge {
            display: inline-block;
            padding: 0.2em 0.6em;
            font-size: 0.8em;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem; /* rounded-md */
        }
        .badge-above-average { background-color: #dbeafe; color: #2563eb; } /* blue-100, blue-600 */
        .badge-average { background-color: #e0e7ff; color: #1e40af; } /* indigo-100, blue-800 */
        .badge-low-average { background-color: #fef9c3; color: #ca8a04; } /* yellow-100, yellow-700 */
        .badge-low { background-color: #ffedd5; color: #ea580c; } /* orange-100, orange-600 */
        .badge-very-low { background-color: #fee2e2; color: #b91c1c; } /* red-100, red-700 */
        .badge-met { background-color: #dbeafe; color: #2563eb; } /* blue-100, blue-600 */
        .badge-not-met { background-color: #fee2e2; color: #991b1b; } /* red-100, red-800 */
        .badge-severe { background-color: #fee2e2; color: #b91c1c; } /* red-100, red-700 */
        .badge-moderate { background-color: #fef3c7; color: #ea580c; } /* yellow-100, orange-600 */
        .badge-mild { background-color: #fef9c3; color: #f59e42; } /* yellow-100, orange-500 */
        .badge-not-problem { background-color: #dbeafe; color: #2563eb; } /* blue-100, blue-600 */

        /* Style for tables */
        table {
            width: 100%;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem; /* p-3 px-4 */
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* divide-y divide-gray-200 */
        }
        th {
            background-color: #dbeafe !important; /* bg-blue-100 */
            color: #1e3a8a !important; /* text-blue-900 */
        }
        tbody tr:nth-child(even) {
            background-color: #eff6ff !important; /* bg-blue-50 */
        }
        tbody tr:nth-child(odd) {
            background-color: #ffffff !important;
        }
        td {
            font-size: 0.875rem; /* text-sm */
            color: #334155 !important; /* slate-700 */
        }
        /* Card styling */
        .report-card {
            background-color: white;
            padding: 1.5rem 0.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        /* Ensure canvas is responsive */
        .chart-container canvas {
            max-width: 100%;
            height: 480px !important;
            min-height: 480px !important;
            width: 800px !important;
            min-width: 600px !important;
            background: #fff;
        }
        h1, h2, h3, .text-blue-heading {
            color: #1e3a8a !important; /* text-blue-900 */
        }
        /* Bar chart width and height override */
        #cognitiveBarChart {
            width: 250px !important;
            min-width: 250px !important;
            height: 800px !important;
            min-height: 800px !important;
        }
    </style>
    <!-- Inject JSON data for Chart.js and dynamic report rendering -->
    <script>
        window.reportData = {{ report_data | tojson | safe }};
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof populateReport === 'function') {
                populateReport();
            }
        });
    </script>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">

        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ADHD Cognitive Assessment Report</h1>
            <p class="text-lg text-gray-600">
                Patient ID: <span id="patient-id">{{ report_data.patient_id or 'N/A' }}</span>
                &nbsp;|&nbsp;
                Test Date: <span id="test-date">{{ report_data.test_date or 'N/A' }}</span>
            </p>
        </header>

        <section class="report-card mb-6" aria-labelledby="validity-warnings-heading">
            <h2 id="validity-warnings-heading" class="text-2xl font-semibold text-yellow-700 mb-4">Validity Warnings</h2>
            <div id="validity-warnings-content" class="text-sm text-yellow-800">
                <!-- Populated by JS -->
            </div>
        </section>

        <section class="report-card mb-6" aria-labelledby="cognitive-profile-heading">
            <h2 id="cognitive-profile-heading" class="text-xl font-semibold text-gray-700 mb-4">Cognitive Domain Profile (Percentiles)</h2>
            <div class="relative mx-auto chart-container" style="max-width: 500px;">
                <canvas id="cognitiveRadarChart"></canvas>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">Scores shown are percentiles (%). Higher scores indicate better performance relative to peers.</p>
        </section>

        <!-- PAGE BREAK BEFORE Cognitive Domain Scores -->
        <div style="page-break-before: always;"></div>

        <section class="report-card" aria-labelledby="cognitive-scores-heading">
            <h2 id="cognitive-scores-heading" class="text-xl font-semibold text-gray-700 mb-4">Cognitive Domain Scores</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                <div class="md:col-span-2">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col">Domain</th>
                                    <th scope="col">Std Score</th>
                                    <th scope="col">%ile</th>
                                    <th scope="col">Class</th>
                                    <th scope="col">Valid</th>
                                </tr>
                            </thead>
                            <tbody id="cognitive-scores-table" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="text-center text-gray-500 py-4">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 class="text-md font-semibold text-gray-700 mb-2">Score Interpretation Guide</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                            <div><span class="badge badge-above-average mr-1">> 75%ile</span> Above Average</div>
                            <div><span class="badge badge-average mr-1">25-75%ile</span> Average</div>
                            <div><span class="badge badge-low-average mr-1">9-25%ile</span> Low Average</div>
                            <div><span class="badge badge-low mr-1">2-9%ile</span> Low</div>
                            <div><span class="badge badge-very-low mr-1">â‰¤ 2%ile</span> Very Low</div>
                        </div>
                         <p class="text-xs text-gray-500 mt-2">Classification based on Percentile (%ile). Std Score = Standard Score.</p>
                    </div>
                </div>
                <div class="chart-container" style="height:480px;margin-top:56px;">
                     <canvas id="cognitiveBarChart" style="height:100%; width:100%;"></canvas>
                     <p class="text-center text-xs text-gray-500 mt-2">Standard Scores (Average = 100, SD = 15). Higher bars indicate better performance.</p>
                </div>
            </div>
        </section>
        <!-- PAGE BREAK AFTER Cognitive Domain Scores -->
        <div style="page-break-after: always;"></div>

        <section class="report-card" aria-labelledby="subtest-results-heading">
            <h2 id="subtest-results-heading" class="text-xl font-semibold text-gray-700 mb-4">Subtest Results</h2>
            <div id="subtest-tables-container" class="space-y-6">
                <p class="text-center text-gray-500 py-4">Loading data...</p>
            </div>
        </section>

        <section class="report-card" aria-labelledby="asrs-dsm-heading">
            <h2 id="asrs-dsm-heading" class="text-xl font-semibold text-gray-700 mb-4">ASRS to DSM-5 Mapping</h2>
            <h3 class="text-lg font-medium text-gray-600 mb-2">Criterion A: Inattention</h3>
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col">DSM-5 Criterion</th>
                            <th scope="col">ASRS Question</th>
                            <th scope="col">Response</th>
                            <th scope="col">Met</th>
                        </tr>
                    </thead>
                    <tbody id="asrs-inattention-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center text-gray-500 py-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="asrs-inattention-summary" class="text-sm font-medium text-gray-700 mb-4">Loading summary...</p>
            <h3 class="text-lg font-medium text-gray-600 mb-2">Criterion B: Hyperactivity/Impulsivity</h3>
             <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col">DSM-5 Criterion</th>
                            <th scope="col">ASRS Question</th>
                            <th scope="col">Response</th>
                            <th scope="col">Met</th>
                        </tr>
                    </thead>
                    <tbody id="asrs-hyperactivity-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center text-gray-500 py-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <p id="asrs-hyperactivity-summary" class="text-sm font-medium text-gray-700 mb-4">Loading summary...</p>
            <h3 class="text-lg font-medium text-gray-600 mb-2">ADHD Diagnosis Summary</h3>
            <div id="adhd-diagnosis-summary" class="text-sm space-y-1">
                <p>Loading summary...</p>
            </div>
        </section>

        <section class="report-card" aria-labelledby="epworth-heading">
            <h2 id="epworth-heading" class="text-xl font-semibold text-gray-700 mb-4">Epworth Sleepiness Scale</h2>
             <div class="overflow-x-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col">Situation</th>
                            <th scope="col">Score (0-3)</th>
                        </tr>
                    </thead>
                    <tbody id="epworth-responses-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="2" class="text-center text-gray-500 py-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="epworth-summary" class="text-sm font-semibold text-gray-700 bg-gray-100 p-3 rounded-md">
                Loading summary...
            </div>
        </section>

        <section class="report-card" aria-labelledby="npq-summary-heading">
            <h2 id="npq-summary-heading" class="text-xl font-semibold text-gray-700 mb-4">NPQ LF-207 Diagnostic Screen Summary</h2>
            <p class="text-xs text-gray-500 mb-4 italic">Note: The NPQ is a clinical screening tool. Scores suggest potential symptom burden and are not diagnostic. Results should be used as a basis for clinical enquiry rather than diagnosis.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col">Domain</th>
                            <th scope="col">Score</th>
                            <th scope="col">Severity</th>
                        </tr>
                    </thead>
                    <tbody id="npq-scores-table" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center text-gray-500 py-4">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
             <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-md font-semibold text-gray-700 mb-2">Severity Legend</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                    <div><span class="badge badge-severe mr-1">Severe</span></div>
                    <div><span class="badge badge-moderate mr-1">Moderate</span></div>
                    <div><span class="badge badge-mild mr-1">Mild</span></div>
                    <div><span class="badge badge-not-problem mr-1">Not a problem</span></div>
                </div>
            </div>
        </section>

        <section class="report-card" aria-labelledby="npq-details-heading">
            <h2 id="npq-details-heading" class="text-xl font-semibold text-gray-700 mb-4">Detailed NPQ Responses</h2>
            <div id="npq-details-container" class="space-y-6">
                 <p class="text-center text-gray-500 py-4">Loading data...</p>
            </div>
        </section>

        <footer class="mt-12 text-center text-xs text-gray-500">
            Report Generated: <span id="generation-date"></span> | Patient ID: <span id="patient-id-footer">{{ report_data.patient_id or 'N/A' }}</span>
        </footer>

    </div>

    <script>
        // ========================================================================
        // TEMPLATE USAGE INSTRUCTIONS:
        // 1. Load your JSON data (e.g., via fetch, file upload, etc.).
        // 2. Assign the loaded JSON object to the global variable `reportData`.
        // 3. Call `populateReport()` function manually after data is loaded.
        // ========================================================================

        let cognitiveRadarChartInstance = null; // To hold the radar chart instance
        let cognitiveBarChartInstance = null; // To hold the bar chart instance

        // --- Helper Functions ---
        function getClassification(percentile) {
            const p = parseFloat(percentile);
            if (isNaN(p)) return { text: 'N/A', class: '' };
            if (p > 75) return { text: 'Above Average', class: 'badge-above-average' };
            if (p >= 25) return { text: 'Average', class: 'badge-average' };
            if (p >= 9) return { text: 'Low Average', class: 'badge-low-average' };
            if (p >= 2) return { text: 'Low', class: 'badge-low' };
            return { text: 'Very Low', class: 'badge-very-low' };
        }
        function getSeverityClass(severity) {
            if (!severity) return '';
            const lowerSeverity = severity.toLowerCase();
            if (lowerSeverity.includes('severe')) return 'badge-severe';
            if (lowerSeverity.includes('moderate')) return 'badge-moderate';
            if (lowerSeverity.includes('mild')) return 'badge-mild';
            if (lowerSeverity.includes('not a problem')) return 'badge-not-problem';
            return '';
        }
        function getMetClass(isMet) {
            return isMet ? 'badge-met' : 'badge-not-met';
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                console.error("Error formatting date:", e);
                return dateString;
            }
        }

        // --- Chart Creation Functions ---
        function createRadarChart(labels, data) {
            const ctx = document.getElementById('cognitiveRadarChart');
            if (!ctx) {
                console.error("Canvas element for radar chart not found.");
                return;
            }
            if (cognitiveRadarChartInstance) { cognitiveRadarChartInstance.destroy(); }

            const primaryColor = '#2563eb'; const gridColor = '#dbeafe';
            const pointColor = primaryColor; const fontColor = '#334155';

            cognitiveRadarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: { labels: labels, datasets: [{ label: 'Cognitive Percentile', data: data, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: primaryColor, pointBackgroundColor: pointColor, pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: pointColor }] },
                options: {
                    responsive: true, maintainAspectRatio: true, elements: { line: { borderWidth: 2 } },
                    scales: { r: { angleLines: { color: gridColor }, grid: { color: gridColor }, pointLabels: { font: { family: "'Inter', sans-serif", size: 11 }, color: fontColor }, ticks: { beginAtZero: true, min: 0, max: 100, stepSize: 25, backdropColor: 'rgba(255, 255, 255, 0.75)', color: fontColor, font: { family: "'Inter', sans-serif" } }, suggestedMin: 0, suggestedMax: 100 } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return (context.dataset.label || '') + ': ' + (context.parsed.r !== null ? context.parsed.r + '%' : ''); } } } }
                }
            });
        }

        function createBarChart(labels, data) {
             const ctx = document.getElementById('cognitiveBarChart');
            if (!ctx) {
                console.error("Canvas element for bar chart not found.");
                return;
            }
            if (cognitiveBarChartInstance) { cognitiveBarChartInstance.destroy(); }

            const primaryColor = '#2563eb'; // blue-600
            const gridColor = '#dbeafe';    // blue-100
            const fontColor = '#334155';    // slate-700

            // Determine appropriate min/max for standard scores (e.g., 3 SDs from mean 100)
            const minScore = 40; // Math.min(50, ...data); // Or a fixed value like 40-50
            const maxScore = 130;// Math.max(150, ...data); // Or a fixed value like 130)

            // --- DEBUG: Log what is being passed to Chart.js ---
            console.log('Bar Chart Labels:', labels);
            console.log('Bar Chart Data:', data);
            // --- END DEBUG ---

            const barOptions = {
                indexAxis: 'y',
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        min: minScore,
                        max: maxScore,
                        grid: { color: gridColor },
                        title: { display: true, text: 'Standard Score', color: fontColor, font: { family: "'Inter', sans-serif", size: 12 } },
                        ticks: { color: fontColor, font: { family: "'Inter', sans-serif", size: 12 }, stepSize: 10 }
                    },
                    y: {
                        grid: { color: gridColor },
                        ticks: { color: fontColor, font: { family: "'Inter', sans-serif", size: 12 } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Std Score: ${context.parsed.x ?? 'N/A'}`;
                            }
                        }
                    }
                },
                barThickness: 22,
                maxBarThickness: 32,
                categoryPercentage: 0.8,
                barPercentage: 0.8,
            };
            cognitiveBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Standard Score',
                        data: data,
                        backgroundColor: primaryColor,
                        borderRadius: 8,
                    }]
                },
                options: barOptions
            });
        }


        // --- Main Population Function ---
        function populateReport() {
            // Check if reportData is available
            if (typeof reportData === 'undefined' || !reportData) {
                console.error("Report data is not available. Make sure 'reportData' is assigned.");
                document.body.innerHTML = `<div class="text-center text-red-600 font-bold p-10">Error: Report data not loaded.</div>`;
                return;
            }

            const patientId = reportData.patient?.id_number || 'N/A';

            // Populate Header & Footer
            const patientIdHeaderElem = document.getElementById('patient-id-header');
            if (patientIdHeaderElem) patientIdHeaderElem.textContent = patientId;
            const patientIdFooterElem = document.getElementById('patient-id-footer');
            if (patientIdFooterElem) patientIdFooterElem.textContent = patientId;
            const generationDateElem = document.getElementById('generation-date');
            if (generationDateElem) generationDateElem.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Populate Test Date
            const testDateElem = document.getElementById('test-date');
            if (testDateElem) testDateElem.textContent = formatDate(reportData.patient?.referral_received_time);

            // --- Populate Charts & Scores ---
            if (reportData.cognitive_scores) {
                // --- Populate Cognitive Domain Table and Bar Chart from JSON order ---
                if (reportData.cognitive_scores && Array.isArray(reportData.cognitive_scores)) {
                    // Table
                    const cognitiveTableBody = document.getElementById('cognitive-scores-table');
                    if (cognitiveTableBody) cognitiveTableBody.innerHTML = '';
                    const labels = [];
                    const data = [];
                    reportData.cognitive_scores.forEach(score => {
                        // Push for bar chart
                        labels.push(score.domain || 'N/A');
                        data.push(score.standard_score !== null ? parseFloat(score.standard_score) : null);

                        // Table row
                        const stdScore = score.standard_score !== null ? parseFloat(score.standard_score).toFixed(0) : 'N/A';
                        const percentile = score.percentile !== null ? parseFloat(score.percentile).toFixed(0) : 'N/A';
                        const classification = getClassification(score.percentile);
                        const row = `
                            <tr>
                                <td class="py-2 px-3">${score.domain || 'N/A'}</td>
                                <td class="py-2 px-3 text-center">${stdScore}</td>
                                <td class="py-2 px-3 text-center">${percentile}</td>
                                <td class="py-2 px-3 text-center"><span class="badge ${classification.class}">${classification.text}</span></td>
                                <td class="py-2 px-3 text-center">${score.validity_index || 'N/A'}</td>
                            </tr>
                        `;
                        if (cognitiveTableBody) cognitiveTableBody.innerHTML += row;
                    });
                    // Update bar chart with JSON order
                    const wrapLabel = label => {
                        // Split at spaces, max 16 chars per line
                        if (!label) return label;
                        if (label.length <= 16) return label;
                        const words = label.split(' ');
                        let lines = [], line = '';
                        words.forEach(word => {
                            if ((line + ' ' + word).trim().length > 16) {
                                lines.push(line.trim());
                                line = word;
                            } else {
                                line += ' ' + word;
                            }
                        });
                        if (line) lines.push(line.trim());
                        return lines;
                    };
                    const barLabels = reportData.cognitive_scores.map(score => wrapLabel(score.domain));
                    const barData = reportData.cognitive_scores.map(score => score.standard_score !== null ? parseFloat(score.standard_score) : null);
                    createBarChart(barLabels, barData); // Create Bar Chart with wrapped labels

                    // --- Table and grid layout: wider table, narrower chart ---
                    const gridDiv = document.querySelector('.grid.md\\:grid-cols-3');
                    if (gridDiv) {
                        gridDiv.classList.remove('md:grid-cols-3');
                        gridDiv.classList.add('md:grid-cols-3');
                    }
                    const tableDiv = gridDiv?.children[0];
                    if (tableDiv) tableDiv.classList.add('md:col-span-2');
                    const chartDiv = gridDiv?.children[1];
                    if (chartDiv) chartDiv.classList.remove('md:col-span-1');
                }

                // --- Radar Chart Data Prep ---
                const radarLabels = reportData.cognitive_scores.map(score => score.domain);
                const radarData = reportData.cognitive_scores.map(score => score.percentile !== null ? parseFloat(score.percentile) : 0);
                createRadarChart(radarLabels, radarData); // Create Radar Chart
            } else {
                // Handle missing cognitive scores for both charts and table
                const chartContainerRadar = document.getElementById('cognitiveRadarChart')?.parentElement;
                const chartContainerBar = document.getElementById('cognitiveBarChart')?.parentElement;
                const cognitiveTableBody = document.getElementById('cognitive-scores-table');
                if(chartContainerRadar) chartContainerRadar.innerHTML = '<p class="text-center text-gray-500 py-4">Cognitive profile data not available.</p>';
                if(chartContainerBar) chartContainerBar.innerHTML = '<p class="text-center text-gray-500 py-4">Cognitive score data not available.</p>';
                if(cognitiveTableBody) cognitiveTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Cognitive score data missing or invalid.</td></tr>';
            }

            // Populate Subtest Results Tables
            const subtestsContainer = document.getElementById('subtest-tables-container');
            if (reportData.subtests && subtestsContainer) {
                subtestsContainer.innerHTML = ''; // Clear loading indicator
                if (reportData.subtests.length === 0) {
                    subtestsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No subtest data available.</p>';
                } else {
                    const groupedSubtests = reportData.subtests.reduce((acc, test) => {
                        const name = test.subtest_name;
                        if (!acc[name]) { acc[name] = []; }
                        acc[name].push(test);
                        return acc;
                    }, {});

                    for (const testName in groupedSubtests) {
                        const tests = groupedSubtests[testName];
                        if (testName === "Four Part Continuous Performance Test") {
                            tests.sort((a, b) => {
                                const partA = a.metric.match(/Part (\d)/)?.[1] || 0;
                                const partB = b.metric.match(/Part (\d)/)?.[1] || 0;
                                if (partA !== partB) return partA - partB;
                                return a.metric.localeCompare(b.metric);
                            });
                        }

                        let tableHTML = `
                            <div class="overflow-x-auto">
                                <h3 class="text-md font-semibold text-gray-600 mb-2">${testName}</h3>
                                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-md">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col">Metric</th>
                                            <th scope="col">Score</th>
                                            <th scope="col">Standard</th>
                                            <th scope="col">Percentile</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                        `;
                        tests.forEach(metric => {
                            const standardScore = metric.standard_score !== null ? parseFloat(metric.standard_score).toFixed(0) : 'N/A';
                            const percentile = metric.percentile !== null ? parseFloat(metric.percentile).toFixed(0) : 'N/A';
                            const score = metric.score !== null ? parseFloat(metric.score).toFixed(1) : 'N/A';

                            tableHTML += `
                                <tr>
                                    <td class="py-2 px-3">${metric.metric || 'N/A'}</td>
                                    <td class="py-2 px-3 text-center">${score}</td>
                                    <td class="py-2 px-3 text-center">${standardScore}</td>
                                    <td class="py-2 px-3 text-center">${percentile}%</td>
                                </tr>
                            `;
                        });
                        tableHTML += `</tbody></table></div>`;
                        subtestsContainer.innerHTML += tableHTML;
                    }
                }
            } else if (subtestsContainer) {
                subtestsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Subtest data missing or invalid.</p>';
            }

            // Populate ASRS/DSM Mapping
            const asrsInattentionTable = document.getElementById('asrs-inattention-table');
            const asrsHyperactivityTable = document.getElementById('asrs-hyperactivity-table');
            const dassItems = reportData.dass_items || [];
            const asrsResponses = reportData.asrs || [];
            if (asrsInattentionTable) asrsInattentionTable.innerHTML = '';
            if (asrsHyperactivityTable) asrsHyperactivityTable.innerHTML = '';

            if (dassItems.length === 0 || asrsResponses.length === 0) {
                if (asrsInattentionTable) asrsInattentionTable.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">ASRS/DSM data not available.</td></tr>';
                if (asrsHyperactivityTable) asrsHyperactivityTable.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">ASRS/DSM data not available.</td></tr>';
            } else {
                const dsmToAsrsMap = { "A1": "Q7", "A2": "Q8", "A3": "Q9", "A4": "Q1", "A5": "Q2", "A6": "Q4", "A7": "Q10", "A8": "Q11", "A9": "Q3", "B1": "Q5", "B2": "Q12", "B3": "Q13", "B4": "Q14", "B5": "Q6", "B6": "Q15", "B7": "Q16", "B8": "Q17", "B9": "Q18" };
                let inattentionMetCount = 0; let hyperactivityMetCount = 0;

                dassItems.forEach(item => {
                    const isMet = item.is_met === 1; const metClass = getMetClass(isMet); const metText = isMet ? 'Met' : 'Not Met';
                    const criterionCodeMatch = item.dsm_criterion.match(/([AB]\d+):/);
                    let asrsQuestionText = 'N/A'; let asrsResponse = 'N/A';
                    if (criterionCodeMatch) {
                        const criterionCode = criterionCodeMatch[1]; const asrsQNum = dsmToAsrsMap[criterionCode];
                        const asrsItem = asrsResponses.find(q => q.question_text && q.question_text.startsWith(asrsQNum + ':'));
                        if (asrsItem) { asrsQuestionText = asrsItem.question_text; asrsResponse = asrsItem.response; }
                    }
                    const row = `<tr><td class="py-2 px-3">${item.dsm_criterion || 'N/A'}</td><td class="py-2 px-3 text-xs">${asrsQuestionText}</td><td class="py-2 px-3">${asrsResponse}</td><td class="py-2 px-3 text-center"><span class="badge ${metClass}">${metText}</span></td></tr>`;
                    if (item.dsm_category === 'Inattention' && asrsInattentionTable) { asrsInattentionTable.innerHTML += row; if (isMet) inattentionMetCount++; }
                    else if (item.dsm_category === 'Hyperactivity/Impulsivity' && asrsHyperactivityTable) { asrsHyperactivityTable.innerHTML += row; if (isMet) hyperactivityMetCount++; }
                });
                const inattentionSummaryEl = document.getElementById('asrs-inattention-summary'); const hyperactivitySummaryEl = document.getElementById('asrs-hyperactivity-summary'); const diagnosisSummaryEl = document.getElementById('adhd-diagnosis-summary');
                const inattentionNeeded = 5; const hyperactivityNeeded = 5;
                const inattentionOverallMet = inattentionMetCount >= inattentionNeeded; const hyperactivityOverallMet = hyperactivityMetCount >= hyperactivityNeeded;
                if(inattentionSummaryEl) { inattentionSummaryEl.innerHTML = `Summary: ${inattentionMetCount}/9 criteria met (Need â‰¥${inattentionNeeded}) - <span class="font-bold ${inattentionOverallMet ? 'text-green-700' : 'text-red-700'}">${inattentionOverallMet ? 'Met' : 'Not Met'}</span>`; }
                if(hyperactivitySummaryEl) { hyperactivitySummaryEl.innerHTML = `Summary: ${hyperactivityMetCount}/9 criteria met (Need â‰¥${hyperactivityNeeded}) - <span class="font-bold ${hyperactivityOverallMet ? 'text-green-700' : 'text-red-700'}">${hyperactivityOverallMet ? 'Met' : 'Not Met'}</span>`; }
                if(diagnosisSummaryEl) { diagnosisSummaryEl.innerHTML = `<p>Inattention Criteria: <span class="font-semibold ${inattentionOverallMet ? 'text-green-700' : 'text-red-700'}">${inattentionOverallMet ? 'Met' : 'Not Met'}</span></p><p>Hyperactivity/Impulsivity Criteria: <span class="font-semibold ${hyperactivityOverallMet ? 'text-green-700' : 'text-red-700'}">${hyperactivityOverallMet ? 'Met' : 'Not Met'}</span></p><p class="mt-2"><strong>Overall Diagnosis:</strong> <span class="font-semibold text-blue-700">${reportData.dass_summary?.[0]?.diagnosis || 'N/A'}</span></p>`; }
            }

            // Populate Epworth Scale
            const epworthTableBody = document.getElementById('epworth-responses-table');
            const epworthSummaryEl = document.getElementById('epworth-summary');
            if (reportData.epworth && reportData.epworth.responses && reportData.epworth.summary && epworthTableBody && epworthSummaryEl) {
                epworthTableBody.innerHTML = ''; // Clear loading
                if (reportData.epworth.responses.length === 0) { epworthTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-4">No Epworth response data available.</td></tr>'; }
                else { reportData.epworth.responses.forEach(resp => { epworthTableBody.innerHTML += `<tr><td class="py-2 px-3">${resp.situation || 'N/A'}</td><td class="py-2 px-3 text-center">${resp.score !== null ? resp.score : 'N/A'}</td></tr>`; }); }
                const summary = reportData.epworth.summary?.[0];
                epworthSummaryEl.innerHTML = `<strong>Total Score:</strong> ${summary?.total_score ?? 'N/A'} | <strong>Interpretation:</strong> ${summary?.interpretation ?? 'N/A'}`;
            } else if (epworthTableBody && epworthSummaryEl) {
                epworthTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-4">Epworth data missing or invalid.</td></tr>';
                epworthSummaryEl.textContent = 'Epworth summary missing or invalid.';
            }

            // Populate NPQ Summary Table
            const npqTableBody = document.getElementById('npq-scores-table');
            if (reportData.npq_scores && npqTableBody) {
                npqTableBody.innerHTML = ''; // Clear loading
                if (reportData.npq_scores.length === 0) { npqTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No NPQ score data available.</td></tr>'; }
                else {
                    const domainOrder = [ "ADHD", "Attention", "Impulsive", "Learning", "Memory", "Anxiety", "Panic", "Agoraphobia", "Obsessions & Compulsions", "Social Anxiety", "PTSD", "Depression", "Bipolar", "Mood Stability", "Mania", "Aggression", "Autism", "Asperger's", "Psychotic", "Somatic", "Fatigue", "Sleep", "Suicide", "Pain", "Substance Abuse", "MCI", "Concussion", "Anxiety/Depression" ];
                    const sortedScores = reportData.npq_scores.filter(score => score.domain !== "Average Symptom Score").sort((a, b) => { const indexA = domainOrder.indexOf(a.domain); const indexB = domainOrder.indexOf(b.domain); if (indexA !== -1 && indexB !== -1) return indexA - indexB; if (indexA !== -1) return -1; if (indexB !== -1) return 1; return a.domain.localeCompare(b.domain); });
                    sortedScores.forEach(score => { const severityClass = getSeverityClass(score.severity); npqTableBody.innerHTML += `<tr><td class="py-2 px-3">${score.domain || 'N/A'}</td><td class="py-2 px-3 text-center">${score.score !== null ? score.score : 'N/A'}</td><td class="py-2 px-3 text-center"><span class="badge ${severityClass}">${score.severity || 'N/A'}</span></td></tr>`; });
                }
            } else if (npqTableBody) { npqTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">NPQ score data missing or invalid.</td></tr>'; }

            // Populate Detailed NPQ Responses
            const npqDetailsContainer = document.getElementById('npq-details-container');
            if (reportData.npq_questions && npqDetailsContainer) {
                npqDetailsContainer.innerHTML = ''; // Clear loading
                if (reportData.npq_questions.length === 0) { npqDetailsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No detailed NPQ response data available.</p>'; }
                else {
                    const groupedNpqQuestions = reportData.npq_questions.reduce((acc, q) => { const domain = q.domain; if (!acc[domain]) { acc[domain] = []; } acc[domain].push(q); return acc; }, {});
                    const domainOrder = [ "ADHD", "Attention", "Impulsive", "Learning", "Memory", "Anxiety", "Panic", "Agoraphobia", "Obsessions & Compulsions", "Social Anxiety", "PTSD", "Depression", "Bipolar", "Mood Stability", "Mania", "Aggression", "Autism", "Asperger's", "Psychotic", "Somatic", "Fatigue", "Sleep", "Suicide", "Pain", "Substance Abuse", "MCI", "Concussion", "Anxiety/Depression" ];
                    domainOrder.forEach(domainName => {
                        if (groupedNpqQuestions[domainName]) {
                            const questions = groupedNpqQuestions[domainName];
                            let tableHTML = `<div class="overflow-x-auto"><h3 class="text-md font-semibold text-gray-600 mb-2">${domainName}</h3><table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-md"><thead class="bg-gray-50"><tr><th scope="col">Question</th><th scope="col">Score</th><th scope="col">Severity</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                            questions.forEach(q => { const severityClass = getSeverityClass(q.severity); tableHTML += `<tr><td class="py-2 px-3">${q.question_text || 'N/A'}</td><td class="py-2 px-3 text-center">${q.score !== null ? q.score : 'N/A'}</td><td class="py-2 px-3 text-center"><span class="badge ${severityClass}">${q.severity || 'N/A'}</span></td></tr>`; });
                            tableHTML += `</tbody></table></div>`;
                            npqDetailsContainer.innerHTML += tableHTML;
                        }
                    });
                }
            } else if (npqDetailsContainer) { npqDetailsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Detailed NPQ response data missing or invalid.</p>'; }

            // --- Validity Warnings Section ---
            const warnings = [];

            // Domain-level (cognitive_scores) validity
            if (reportData.cognitive_scores) {
                const invalidDomains = reportData.cognitive_scores.filter(score => String(score.validity_index).toLowerCase() !== 'yes');
                if (invalidDomains.length > 0) {
                    warnings.push(`<strong>Domains:</strong> ${invalidDomains.map(s => s.domain).join(', ')}`);
                }
            }
            // Subtest-level validity (if present)
            if (reportData.subtest_scores) {
                // Collect subtest names with at least one invalid flag
                const invalidSubtestNames = Array.from(new Set(
                    reportData.subtest_scores
                        .filter(score => String(score.validity_flag) !== '1')
                        .map(s => s.subtest_name)
                        .filter(Boolean)
                ));
                if (invalidSubtestNames.length > 0) {
                    warnings.push(`<strong>Subtests:</strong> ${invalidSubtestNames.join(', ')}`);
                }
            }
            // Render warnings
            const validityElem = document.getElementById('validity-warnings-content');
            if (validityElem) {
                if (warnings.length > 0) {
                    validityElem.innerHTML = `Possible invalid scores for:<br>${warnings.join('<br>')}`;
                } else {
                    validityElem.innerHTML = `<span class='text-green-700'>No validity warnings detected.</span>`;
                }
            }
        } // End of populateReport function

        // --- Event Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof reportData !== 'undefined' && reportData) { populateReport(); }
            else { console.log("DOM loaded, waiting for reportData to be assigned."); }
        });

        // --- Example: How to load data dynamically and then populate ---
        /*
        async function loadAndPopulate() {
            try {
                await new Promise(resolve => { if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', resolve); } else { resolve(); } });
                console.log("Fetching report data...");
                const response = await fetch('/path/to/your/data.json'); // Replace with your data source
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                window.reportData = await response.json(); // Assign to global scope
                console.log("Report data loaded, populating report...");
                populateReport(); // Call populate function AFTER data is loaded and DOM is ready
            } catch (error) {
                console.error("Failed to load report data:", error);
                if (document.body) { document.body.innerHTML = `<div class="text-center text-red-600 font-bold p-10">Error: Failed to load report data. ${error.message}</div>`; }
                else { document.addEventListener('DOMContentLoaded', () => { document.body.innerHTML = `<div class="text-center text-red-600 font-bold p-10">Error: Failed to load report data. ${error.message}</div>`; }); }
            }
        }
        // loadAndPopulate(); // Call this function to start the process
        */

    </script>
</body>
</html>
